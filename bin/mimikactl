#!/usr/bin/env bash
set -euo pipefail

# MimikaStudio Control Script
# Local-first voice cloning with Qwen3-TTS

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
BACKEND_DIR="$ROOT_DIR/backend"
FLUTTER_DIR="$ROOT_DIR/flutter_app"
PID_DIR="$ROOT_DIR/.pids"
LOG_DIR="$ROOT_DIR/.logs"
RUNS_LOG_DIR="$ROOT_DIR/runs/logs"

# Ports
BACKEND_PORT=8000
MCP_PORT=8010

# Flutter app name
FLUTTER_APP_NAME="mimika_studio"
FLUTTER_APP_BUNDLE_ID="com.mimikastudio.app"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

mkdir -p "$PID_DIR" "$LOG_DIR" "$RUNS_LOG_DIR"

# ============== Helper Functions ==============

print_status() {
    local name="$1"
    local port="$2"
    local pid_file="$PID_DIR/$name.pid"

    if lsof -ti:"$port" &>/dev/null; then
        local pid=$(lsof -ti:"$port" | head -1)
        echo -e "${GREEN}●${NC} $name: ${GREEN}RUNNING${NC} [PID: $pid, Port: $port]"
    else
        echo -e "${RED}○${NC} $name: ${RED}STOPPED${NC}"
    fi
}

kill_port() {
    local port="$1"
    local pids=$(lsof -ti:"$port" 2>/dev/null || true)
    if [ -n "$pids" ]; then
        echo "$pids" | xargs kill -9 2>/dev/null || true
        sleep 1
    fi
}

wait_for_health() {
    local url="$1"
    local max_retries="${2:-30}"
    local retry=0

    echo -n "Waiting for $url "
    while [ $retry -lt $max_retries ]; do
        if curl -s "$url" &>/dev/null; then
            echo -e " ${GREEN}OK${NC}"
            return 0
        fi
        echo -n "."
        sleep 1
        ((retry++))
    done
    echo -e " ${RED}FAILED${NC}"
    return 1
}

# ============== Backend Functions ==============

start_backend() {
    echo -e "${BLUE}Starting backend...${NC}"

    # Kill existing
    kill_port $BACKEND_PORT

    # Check for venv
    if [ ! -d "$BACKEND_DIR/venv" ]; then
        echo "Creating Python virtual environment..."
        python3 -m venv "$BACKEND_DIR/venv"
        source "$BACKEND_DIR/venv/bin/activate"
        pip install -r "$BACKEND_DIR/requirements.txt"
    else
        source "$BACKEND_DIR/venv/bin/activate"
    fi

    # Start FastAPI
    cd "$BACKEND_DIR"
    nohup python main.py > "$LOG_DIR/backend.log" 2>&1 &
    echo $! > "$PID_DIR/backend.pid"

    wait_for_health "http://localhost:$BACKEND_PORT/api/health"
}

stop_backend() {
    echo -e "${BLUE}Stopping backend...${NC}"
    kill_port $BACKEND_PORT
    rm -f "$PID_DIR/backend.pid"
    echo -e "${GREEN}Backend stopped${NC}"
}

# ============== Flutter Functions ==============

start_flutter() {
    local mode="${1:-release}"
    echo -e "${BLUE}Starting Flutter UI ($mode mode)...${NC}"

    cd "$FLUTTER_DIR"

    if [ "$mode" = "dev" ]; then
        flutter run -d macos > "$LOG_DIR/flutter.log" 2>&1 &
        echo $! > "$PID_DIR/flutter.pid"
    else
        # Always rebuild to ensure latest code
        echo "Building Flutter app..."
        flutter build macos --release

        # Launch app
        local app_path="$FLUTTER_DIR/build/macos/Build/Products/Release/MimikaStudio.app"
        if [ -d "$app_path" ]; then
            open "$app_path"
        else
            echo -e "${YELLOW}App not found at $app_path, running in dev mode${NC}"
            flutter run -d macos &
            echo $! > "$PID_DIR/flutter.pid"
        fi
    fi
}

stop_flutter() {
    echo -e "${BLUE}Stopping Flutter UI...${NC}"

    # Kill by PID file
    if [ -f "$PID_DIR/flutter.pid" ]; then
        kill $(cat "$PID_DIR/flutter.pid") 2>/dev/null || true
        rm -f "$PID_DIR/flutter.pid"
    fi

    # Kill app by bundle ID
    osascript -e 'quit app "MimikaStudio"' 2>/dev/null || true

    echo -e "${GREEN}Flutter stopped${NC}"
}

build_flutter() {
    echo -e "${BLUE}Building Flutter app...${NC}"
    cd "$FLUTTER_DIR"
    flutter pub get
    flutter build macos --release
    echo -e "${GREEN}Build complete${NC}"
}

# ============== Model Functions ==============

download_models() {
    echo -e "${BLUE}Downloading models...${NC}"
    source "$BACKEND_DIR/venv/bin/activate"

    # Models are auto-downloaded on first use
    # This just pre-warms them
    python3 -c "
from tts.xtts_engine import get_xtts_engine
from tts.kokoro_engine import get_kokoro_engine

print('Loading XTTS model...')
get_xtts_engine().load_model()

print('Loading Kokoro model...')
get_kokoro_engine().load_model()

print('All models loaded.')
"
    echo -e "${GREEN}Models ready${NC}"
}

# ============== MCP Functions ==============

start_mcp() {
    echo -e "${BLUE}Starting MCP Server...${NC}"

    # Kill existing
    kill_port $MCP_PORT

    # Activate venv
    if [ -f "$BACKEND_DIR/venv/bin/activate" ]; then
        source "$BACKEND_DIR/venv/bin/activate"
    fi

    # Start MCP server
    nohup python3 "$SCRIPT_DIR/tts_mcp_server.py" --host 127.0.0.1 --port $MCP_PORT > "$RUNS_LOG_DIR/mcp_server.log" 2>&1 &
    echo $! > "$PID_DIR/mcp.pid"

    sleep 1
    if lsof -ti:"$MCP_PORT" &>/dev/null; then
        echo -e "${GREEN}MCP Server started${NC} on port $MCP_PORT"
    else
        echo -e "${RED}MCP Server failed to start${NC}"
        tail -5 "$RUNS_LOG_DIR/mcp_server.log" 2>/dev/null || true
    fi
}

stop_mcp() {
    echo -e "${BLUE}Stopping MCP Server...${NC}"
    kill_port $MCP_PORT
    rm -f "$PID_DIR/mcp.pid"
    echo -e "${GREEN}MCP Server stopped${NC}"
}

# ============== Database Functions ==============

seed_db() {
    echo -e "${BLUE}Seeding database...${NC}"
    source "$BACKEND_DIR/venv/bin/activate"
    cd "$BACKEND_DIR"
    python3 database.py
    echo -e "${GREEN}Database seeded${NC}"
}

# ============== Test Functions ==============

run_tests() {
    echo -e "${BLUE}Running API tests...${NC}"
    source "$BACKEND_DIR/venv/bin/activate"
    python3 "$ROOT_DIR/scripts/test_api.py"
}

# ============== Main Commands ==============

cmd_up() {
    local skip_flutter=false
    local skip_mcp=false
    local flutter_mode="dev"

    while [[ $# -gt 0 ]]; do
        case $1 in
            --no-flutter) skip_flutter=true ;;
            --no-mcp) skip_mcp=true ;;
            --flutter-release) flutter_mode="release" ;;
            *) echo "Unknown option: $1" ;;
        esac
        shift
    done

    echo -e "${BLUE}=== Starting MimikaStudio ===${NC}"
    start_backend

    if [ "$skip_mcp" = false ]; then
        start_mcp
    fi

    if [ "$skip_flutter" = false ]; then
        start_flutter "$flutter_mode"
    fi

    echo ""
    echo -e "${GREEN}=== MimikaStudio Ready ===${NC}"
    echo -e "Backend:    http://localhost:$BACKEND_PORT"
    echo -e "API Docs:   http://localhost:$BACKEND_PORT/docs"
    echo -e "MCP Server: http://localhost:$MCP_PORT"
}

cmd_down() {
    echo -e "${BLUE}=== Stopping MimikaStudio ===${NC}"
    stop_flutter
    stop_mcp
    stop_backend
    echo -e "${GREEN}=== MimikaStudio Stopped ===${NC}"
}

cmd_status() {
    echo -e "${BLUE}=== MimikaStudio Status ===${NC}"
    echo ""
    echo -e "${GREEN}Services:${NC}"
    print_status "Backend" $BACKEND_PORT
    print_status "MCP Server" $MCP_PORT

    # Flutter status (check by PID or app process)
    local flutter_running=false
    if [ -f "$PID_DIR/flutter.pid" ]; then
        local pid=$(cat "$PID_DIR/flutter.pid")
        if kill -0 "$pid" 2>/dev/null; then
            flutter_running=true
            echo -e "${GREEN}●${NC} Flutter UI: ${GREEN}RUNNING${NC} [PID: $pid]"
        fi
    fi
    # Also check for running app
    if [ "$flutter_running" = false ]; then
        local app_pid=$(pgrep -f "$FLUTTER_APP_NAME.app/Contents/MacOS" 2>/dev/null | head -1 || true)
        if [ -n "$app_pid" ]; then
            echo -e "${GREEN}●${NC} Flutter UI: ${GREEN}RUNNING${NC} [PID: $app_pid]"
        else
            echo -e "${RED}○${NC} Flutter UI: ${RED}STOPPED${NC}"
        fi
    fi

    echo ""
    echo -e "${GREEN}Logs:${NC}"
    echo "  mimikactl logs backend   - Backend logs"
    echo "  mimikactl logs mcp       - MCP server logs"
    echo "  mimikactl logs flutter   - Flutter logs"
    echo "  mimikactl logs all       - Tail all logs"
}

cmd_restart() {
    cmd_down
    sleep 2
    cmd_up "$@"
}

cmd_logs() {
    local target="${1:-backend}"

    case "$target" in
        backend)
            log_file="$LOG_DIR/backend.log"
            ;;
        mcp)
            log_file="$RUNS_LOG_DIR/mcp_server.log"
            ;;
        flutter)
            log_file="$LOG_DIR/flutter.log"
            ;;
        all)
            echo "Tailing all logs (Ctrl+C to exit)..."
            tail -f "$LOG_DIR"/*.log "$RUNS_LOG_DIR"/*.log 2>/dev/null
            return
            ;;
        *)
            log_file="$LOG_DIR/$target.log"
            if [ ! -f "$log_file" ]; then
                log_file="$RUNS_LOG_DIR/$target.log"
            fi
            ;;
    esac

    if [ -f "$log_file" ]; then
        echo "Tailing $log_file (Ctrl+C to exit)..."
        tail -f "$log_file"
    else
        echo "Log file not found: $log_file"
        echo "Available logs:"
        ls -1 "$LOG_DIR"/*.log "$RUNS_LOG_DIR"/*.log 2>/dev/null || echo "  (none)"
    fi
}

# ============== Usage ==============

usage() {
    cat << EOF
${BLUE}MimikaStudio Control Script${NC}

Usage: mimikactl <command> [options]

${GREEN}Service Commands:${NC}
    up [options]                Start all services (Backend + MCP + Flutter)
        --no-flutter            Skip Flutter UI
        --no-mcp                Skip MCP server
        --flutter-release       Run Flutter in release mode (default: dev)
    down                        Stop all services
    restart                     Restart all services
    status                      Show service status

${GREEN}Backend Commands:${NC}
    backend start               Start backend only
    backend stop                Stop backend

${GREEN}Flutter Commands:${NC}
    flutter start [--dev]       Start Flutter UI
    flutter stop                Stop Flutter UI
    flutter build               Build Flutter macOS app

${GREEN}MCP Server Commands:${NC}
    mcp start                   Start MCP server (for Codex CLI)
    mcp stop                    Stop MCP server
    mcp status                  Check MCP server status

${GREEN}Model Commands:${NC}
    models download             Pre-download ML models

${GREEN}Database Commands:${NC}
    db seed                     Seed database

${GREEN}Utility Commands:${NC}
    logs [service]              Tail logs (backend|mcp|flutter|all)
    test                        Run API tests
    clean                       Clean logs and temp files
    version                     Show version info

${GREEN}Examples:${NC}
    mimikactl up                   # Start everything
    mimikactl up --no-flutter      # Backend + MCP only
    mimikactl status               # Check what's running
    mimikactl logs backend         # Tail backend logs
    mimikactl mcp start            # Start MCP for Codex CLI

EOF
}

# ============== Main ==============

case "${1:-}" in
    up) shift; cmd_up "$@" ;;
    down) cmd_down ;;
    restart) shift; cmd_restart "$@" ;;
    status) cmd_status ;;
    backend)
        case "${2:-}" in
            start) start_backend ;;
            stop) stop_backend ;;
            *) echo "Usage: mimikactl backend {start|stop}" ;;
        esac
        ;;
    flutter)
        case "${2:-}" in
            start) start_flutter "${3:-release}" ;;
            stop) stop_flutter ;;
            build) build_flutter ;;
            *) echo "Usage: mimikactl flutter {start|stop|build}" ;;
        esac
        ;;
    mcp)
        case "${2:-}" in
            start) start_mcp ;;
            stop) stop_mcp ;;
            status)
                echo -e "${BLUE}MCP Server Status:${NC}"
                print_status "MCP Server" $MCP_PORT
                ;;
            *) echo "Usage: mimikactl mcp {start|stop|status}" ;;
        esac
        ;;
    models)
        case "${2:-}" in
            download) download_models ;;
            *) echo "Usage: mimikactl models download" ;;
        esac
        ;;
    db)
        case "${2:-}" in
            seed) seed_db ;;
            *) echo "Usage: mimikactl db seed" ;;
        esac
        ;;
    logs) shift; cmd_logs "${1:-backend}" ;;
    test) run_tests ;;
    clean)
        echo -e "${BLUE}Cleaning temporary files...${NC}"
        rm -rf "$LOG_DIR"/*.log 2>/dev/null || true
        rm -rf "$RUNS_LOG_DIR"/*.log 2>/dev/null || true
        rm -rf "$PID_DIR"/*.pid 2>/dev/null || true
        echo -e "${GREEN}Cleaned.${NC}"
        ;;
    version)
        echo -e "${BLUE}MimikaStudio - Text-to-Speech UI${NC}"
        echo "Version: 1.0.0"
        echo "Root: $ROOT_DIR"
        echo ""
        echo "Components:"
        command -v python3 >/dev/null && echo "  Python: $(python3 --version 2>&1 | cut -d' ' -f2)"
        command -v flutter >/dev/null && echo "  Flutter: $(flutter --version 2>&1 | head -1 | cut -d' ' -f2)"
        ;;
    generate)
        case "${2:-}" in
            emma-audio)
                echo -e "${BLUE}Generating Emma IPA audio...${NC}"
                source "$BACKEND_DIR/venv/bin/activate"
                python3 "$BACKEND_DIR/scripts/generate_emma_ipa_audio.py"
                echo -e "${GREEN}Audio generated${NC}"
                ;;
            *) echo "Usage: mimikactl generate {emma-audio}" ;;
        esac
        ;;
    help|-h|--help) usage ;;
    *) usage ;;
esac
